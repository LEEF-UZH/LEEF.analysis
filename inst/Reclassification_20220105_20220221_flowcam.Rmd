---
title: "Reclassification"
author: "Rainer M Krug"
date: "1/10/2022"
output:
  html_document:
    dev: png
    fig_width: 10
    fig_height: 12
    toc: true
    toc_float: true
    toc_collapsed: true
    code_folding: hide
params:
  output_dir: ~/RRD.Reclasification_20220105_to_20220221_flowcam/
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  message = TRUE,
  warning = TRUE
)
library("LEEF.analysis")
```

# Preparation
This reclassification is based on the classifiers as in the repo at the base URL which specifies the repo and the reference / tag which should be used for this reclassification
```{r}
base <- paste0("https://github.com/LEEF-UZH/LEEF.parameter/raw/", "v1.4.0", "/")
```

## Set output path
```{r output_path}
output = params$output
dir.create(output, recursive = TRUE, showWarnings = FALSE)
```


## Set Archive Directory
Make sure, that the S3 LEEF archive is mounted and you know the path to the archive as it is needed.

```{r setArchive}
archive_dir <- "~/Duck/LEEFSwift3/"
if (!file.exists(archive_dir)){
  stop(
    "Archive directory '", archive_dir, "' does not exist.\n",
    "Probably not mounted?" 
  )
}
```

## Set number of cores to be used
```{r setCores}
cores <- 7
```

## Set timestamps
```{r timestamps}
timestamps <- c(
  20220105, 20220107,
  20220110, 20220112, 20220114,
  20220117, 20220119, 20220121,
  20220124, 20220126, 20220128,
  20220131, 20220202, 20220204,
  20220207, 20220209, 20220211,
  20220214, 20220216, 20220218,
  20220221
  )
```


# Reclassification 

## Flowcam

### Prepare Flowcam
```{r prepare_flowcam}
pdir <- tempfile()
dir.create(pdir, showWarnings = FALSE, recursive = TRUE)

class_constant <- file.path(pdir, "class_constant.rds")
download.file(
  paste0(base, "parameter/flowcam/svm_flowcam_classifiers_18c_decrLight18_trained_earlyFeb22.rds"), 
  destfile = class_constant,
  mode = "wb"
)

class_increasing <- file.path(pdir, "class_increasing.rds")
download.file(
  paste0(base, "parameter/flowcam/svm_flowcam_classifiers_18c_normLight30_trained_earlyFeb22.rds"), 
  destfile = class_increasing,
  mode = "wb"
)
```

### Classify Flowcam
```{r classify_flowcam}
out <- file.path(output, "flowcam")
if (!file.exists(out)) {
  message("Classifying flowcam...")
  system.time(
    LEEF.analysis::classify_flowcam_archive(
      archive_dir = archive_dir, 
      timestamps = timestamps, 
      algae_traits_name = "algae_traits_filtered.rds", 
      classifier_constant_name = class_constant, 
      classifier_increasing_name = class_increasing, 
      species_tracked = yaml::read_yaml(paste0(base, "parameter/flowcam/flowcam.yml"))$species_tracked,
      output = out,
      mc.cores = cores
    )
  )
} else {
  message(
    "Directory ", out, "exists\n",
    "skipping Flowcam."
  )
}
```

### Clean Up Flowcam
```{r cleanup_flowcam}
unlink(pdir)
rm(class_constant, class_increasing, out, species_tracked)
```

# Add to database
```{r addRRD}
system.time(
  add_reclassified_to_db(
    path = output, 
    db = file.path(output, "LEEF.RRD.reclassified.sqlite"), 
    remove_timestamps = timestamps
  )
)
```

# Add experiment specific tables
```{r addExptables}
pdir <- tempfile()
dir.create(pdir, showWarnings = FALSE, recursive = TRUE)

experimental_design <- file.path(pdir, "experimental_design.csv")
download.file(
  paste0(base, "parameter/00.general.parameter/experimental_design.csv"), 
  destfile = experimental_design,
  mode = "wb"
)

compositions <- file.path(pdir, "compositions.csv")
download.file(
  paste0(base, "parameter/00.general.parameter/compositions.csv"), 
  destfile = experimental_design,
  mode = "wb"
)

add_experiment_tables(
  db = file.path(output, "LEEF.RRD.reclassified.sqlite"), 
  composition = compositions, 
  experimetal_design = experimental_design
)

unlink(pdir)
rm(pdir, compositions, add_experiment_tables)
```

# Create Diagnostic Report
```{r createDiagReport}
report_diagnostic(
  db = file.path(output, "LEEF.RRD.reclassified.sqlite"), 
  suffix = "reclassified", 
  format = "html"
)
```

