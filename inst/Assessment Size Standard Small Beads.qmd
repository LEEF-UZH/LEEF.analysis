---
title: "Assessment Size Standards fsc"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    embed-resources: true
params: 
  root_dir: "~/Desktop/size_check_beads/"

---

## Assessment of Size Standards

ADD HOW CALCULATED / EXTRACTED

```{r}
#| label: setup
#| 
#| 

library(ggplot2)
library(LEEF.analysis)
library(dplyr)
```

```{r}
#| label: load_or_extract_traits


# log transform everything which had not been transformed in the pipeline
samples <- c("20230324_beads_threshold_fsc20", "20230327_beads_threshold_fsc")

traits <- lapply(
  samples,
  function(sample){
    if (file.exists(file.path(params$root_dir, sample, "traits.rds"))) {
      traits <- readRDS(file.path(params$root_dir, sample, "traits.rds"))
      traits$bead_size <- NA
    } else {
      fsa <- readRDS(file.path(params$root_dir, sample, "2.extracted_data", "flowcytometer", "flowcytometer_fsa_ungated.rds"))
      fsa <- flowCore::transform(
        fsa,
        flowCore::transformList(
          c("FL2-A", "FL1-H", "FL2-H", "FL3-H", "FL4-H", "FSC-H", "SSC-H"),
          flowCore::truncateTransform("truncate at 1")
        )
      )
      fsa <- flowCore::transform(
        fsa,
        flowCore::transformList(
          c("FL2-A", "FL1-H", "FL2-H", "FL3-H", "FL4-H", "FSC-H", "SSC-H"), 
          "log10"
        )
      )
      
      metadata <- utils::read.csv(file.path(params$root_dir, sample, "2.extracted_data", "flowcytometer", "metadata_flowcytometer.csv"))
      
      gates_coordinates <- data.frame(
        bacteria1 = c(3.301029996, 3.301029996, 7.204119983, 7.204119983), 
        bacteria2 = c(0,           3.301029996, 6.301029996, 0.         ), 
        LNA =       c(3.301029996, 4.579784,    NA,          NA         ), 
        MNA =       c(4.579785,    4.954243,    NA,          NA         ), 
        HNA =       c(4.954244,    7.204119983, NA,          NA         ), 
        algae1 =    c(3,           3,           7.204119983, 7.204119983), 
        algae2 =    c(3.301029996, 7.204119983, 7.204119983, 3.301029996)
      )
      
      traits <- LEEF.measurement.flowcytometer::extract_traits(
        particles = "all",
        metadata_flowcytometer = metadata,
        use_H = FALSE, 
        excl_FSCA_0 = FALSE,
        timestamp = 99999999,
        gates_coordinates = gates_coordinates,
        fsa = fsa
      )[[1]]
      
      traits$beads[traits$sample == "A01"] <- "0.2"
      traits$beads[traits$sample == "A02"] <- "0.45"
      traits$beads[traits$sample == "A03"] <- "0.88"
      traits$beads[traits$sample == "A04"] <- "1.25"
      traits$beads[traits$sample == "A05"] <- "1, 3, 10"
      traits$beads[traits$sample == "A06"] <- "1, 3, 10"

      traits$bead_size <- NA
    }
    return(traits)
  }
)
```

## The one from the Means
```{r}
#| label: ss_means
#| 
ss_repaired <- list()
ss_repaired$data <- data.frame(
  diameter_micrometer = c(1L, 3L, 10L), 
  mean_FSC.A = c(102045L, 641752L, 1959230L), 
  mean_FSC.H = c(106576L, 648403L, 1303073L)
)

ss_repaired$fit.A <- lm(ss_repaired$data$diameter_micrometer ~ ss_repaired$data$mean_FSC.A)
ss_repaired$slope_A <- ss_repaired$fit.A$coefficients[[2]]
ss_repaired$intercept_A <- ss_repaired$fit.A$coefficients[[1]]

ss_repaired$fit.H <- lm(ss_repaired$data$diameter_micrometer ~ ss_repaired$data$mean_FSC.H)
ss_repaired$slope_H <- ss_repaired$fit.H$coefficients[[2]]
ss_repaired$intercept_H <- ss_repaired$fit.H$coefficients[[1]]
```

## 20230324_beads_threshold_fsc20
I excluded all values < 0.5 from the plots.

### 0.2 Beads
```{r}
beads_type <- "0.2"

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(0.5, 6), bw = 0.01)

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(0.5, 6), bw = 0.01)
```


### 0.45 Beads
```{r}
beads_type <- "0.45"

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(0.5, 6), bw = 0.01)


traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(3, 6), bw = 0.01) +
  geom_vline(xintercept = c(3.5, 4.05), col = "green")

i <- traits[[1]]$beads == beads_type & traits[[1]]$SSC.A >= 3.5 & traits[[1]]$SSC.A <= 4.05
traits[[1]][i,]$bead_size <- 0.45
```

### 0.88 Beads
```{r}
beads_type <- "0.88"

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(3, 6), bw = 0.01) +
  geom_vline(xintercept = c(4.4, 4.7), col = "green")

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(3, 6), bw = 0.01) +
  geom_vline(xintercept = c(4.2, 4.6), col = "green")

i <- traits[[1]]$beads == beads_type & traits[[1]]$SSC.A >= 4.2 & traits[[1]]$SSC.A <= 4.6
traits[[1]][i,]$bead_size <- 0.88

```

### 1.25 Beads
```{r}
beads_type <- "1.25"

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(4, 8), bw = 0.01) +
  geom_vline(xintercept = c(5.1, 5.4), col = "green")

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(4, 7), bw = 0.01) +
  geom_vline(xintercept = c(4.75, 5.25), col = "green")

i <- traits[[1]]$beads == beads_type & traits[[1]]$SSC.A >= 4.75 & traits[[1]]$SSC.A <= 5.25
traits[[1]][i,]$bead_size <- 1.25
```


### 1, 3, 10 Beads
```{r}
beads_type <- "1, 3, 10"

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(4.5,8), bw = 0.01) +
  geom_vline(xintercept = c(4.9, 5.2), col = "green") +  
  geom_vline(xintercept = c(5.7, 5.95), col = "green") +  
  geom_vline(xintercept = c(6.15, 6.4), col = "green")

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(4.5, 7), bw = 0.01) +
  geom_vline(xintercept = c(4.7, 4.9), col = "green") +  
  geom_vline(xintercept = c(5.5, 5.8), col = "green") +  
  geom_vline(xintercept = c(6.1, 6.45), col = "green")

i <- traits[[1]]$beads == beads_type & traits[[1]]$SSC.A >= 4.7 & traits[[1]]$SSC.A <= 4.9
traits[[1]][i,]$bead_size <- 1

i <- traits[[1]]$beads == beads_type & traits[[1]]$SSC.A >= 5.5 & traits[[1]]$SSC.A <= 5.8
traits[[1]][i,]$bead_size <- 3

i <- traits[[1]]$beads == beads_type & traits[[1]]$SSC.A >= 6.1 & traits[[1]]$SSC.A <= 6.45
traits[[1]][i,]$bead_size <- 10
```



## 20230327_beads_threshold_fsc
I excluded all values < 0.5 from the plots.

### 0.2 Beads
```{r}
beads_type <- "0.2"

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(0.5, 6), bw = 0.01)

traits[[1]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(0.5, 6), bw = 0.01)
```


### 0.45 Beads
```{r}
beads_type <- "0.45"

traits[[2]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(0.5, 6), bw = 0.01)


traits[[2]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(3, 6), bw = 0.01) +
  geom_vline(xintercept = c(3.5, 4.05), col = "green")

i <- traits[[2]]$beads == beads_type & traits[[2]]$SSC.A >= 3.5 & traits[[2]]$SSC.A <= 4.05
traits[[2]][i,]$bead_size <- 0.45

```

### 0.88 Beads
```{r}
beads_type <- "0.88"

traits[[2]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(3, 6), bw = 0.01) +
  geom_vline(xintercept = c(4.4, 4.7), col = "green")

traits[[2]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(3, 6), bw = 0.01) +
  geom_vline(xintercept = c(4.4, 4.7), col = "yellow") + 
  geom_vline(xintercept = c(4.3, 4.56), col = "green")

i <- traits[[2]]$beads == beads_type & traits[[2]]$SSC.A >= 4.3 & traits[[2]]$SSC.A <= 4.56
traits[[2]][i,]$bead_size <- 0.88

```

### 1.25 Beads
```{r}
beads_type <- "1.25"

traits[[2]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(4, 6), bw = 0.01) +
  geom_vline(xintercept = c(5.1, 5.4), col = "green")

traits[[2]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(4, 6), bw = 0.01) +
  geom_vline(xintercept = c(4.75, 5.25), col = "green")

i <- traits[[2]]$beads == beads_type & traits[[2]]$SSC.A >= 4.75 & traits[[2]]$SSC.A <= 5.25
traits[[2]][i,]$bead_size <- 1.25
```


### 1, 3, 10 Beads
```{r}
beads_type <- "1, 3, 10"

traits[[2]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = FSC.A)) + 
  ggplot2::geom_density(bounds = c(4.5,8), bw = 0.01) +
  geom_vline(xintercept = c(4.9, 5.2), col = "green") +  
  geom_vline(xintercept = c(5.7, 5.95), col = "green") +  
  geom_vline(xintercept = c(6.15, 6.4), col = "green")

traits[[2]] |> 
  dplyr::filter(beads == beads_type) |>
  ggplot(aes( x = SSC.A)) + 
  ggplot2::geom_density(bounds = c(4.5, 7), bw = 0.01) +
  geom_vline(xintercept = c(4.7, 4.9), col = "green") +  
  geom_vline(xintercept = c(5.5, 5.8), col = "green") +  
  geom_vline(xintercept = c(6.1, 6.45), col = "green")

i <- traits[[2]]$beads == beads_type & traits[[2]]$SSC.A >= 4.7 & traits[[2]]$SSC.A <= 4.9
traits[[2]][i,]$bead_size <- 1
i <- traits[[2]]$beads == beads_type & traits[[2]]$SSC.A >= 5.5 & traits[[2]]$SSC.A <= 5.8
traits[[2]][i,]$bead_size <- 3
i <- traits[[2]]$beads == beads_type & traits[[2]]$SSC.A >= 6.1 & traits[[2]]$SSC.A <= 6.45
traits[[2]][i,]$bead_size <- 10
```

# Number of particles per bead size
```{r}
#| label: acatterplots
#| 
traits[[1]]$bead_size |> table()
traits[[2]]$bead_size |> table()
```

# Save
```{r}
#| label: save
#| 

for (i in 1:length(samples)){
  saveRDS(traits[[i]], file.path(params$root_dir, samples[[i]], "traits.rds"))
}      

```
