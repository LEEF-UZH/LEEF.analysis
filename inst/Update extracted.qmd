---
title: "Update `extracted`"
author: "Rainer M Krug"
date: "06/05/2022"
input:
  html_document:
    dev: png
    fig_width: 10
    fig_height: 12
    toc: true
    toc_float: true
    toc_collapsed: true
    code_folding: hide
params:
  input_dir: ~/reclassification/
  archive_dir: /Volumes/LEEF/
  extracted_dir: /Volumes/LEEF/LEEF.archived.data/LEEF/3.archived.data/extracted/
  avi_dir: ~/Duck/LEEFSwift3/LEEF.archived.data/LEEF/3.archived.data/pre_processed
---

```{r}
#| label = "setup_reclass",
#| include = FALSE
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  message = TRUE,
  warning = TRUE
)
library(pbmcapply)
library(yaml)
library(LEEF.analysis)
```

# Preparation
## Set input path 
The input path contains the reclassified data and was output path in the reclassification.
```{r}
#| label = "input_path"
input <-  params$input
```

## Set Archive Directory
Make sure, that id does not point to the the S3 LEEF archive, but to a writable location containing the extracted data

```{r}
#| label = "setArchive"
if (!file.exists(params$archive_dir)){
  stop(
    "Expected directory '", params$extracted_dir, "' does not exist.\n",
    "Probably not mounted?" 
  )
}
testfile <- file.path(params$extracted_dir, "test.tmp")
file.create(testfile)
if (!file.exists(testfile)){
  stop("The location ", testfile, " is not writable!")
}
unlink(testfile)
rm(testfile)
```

## Set number of cores to be used
```{r}
#| label = "setCores"
cores <- 7
```

# Update `bemovi.mag.16`

## Define paths and files
```{r}
#| label = "define_bemovi_mag_16_parameter"
source_dir <- file.path(input, "bemovi_mag_16")
source_files <- list.files(source_dir, pattern = ".rds$", recursive = TRUE)
timestamps <- sapply( strsplit(source_files, "\\."), "[[", 2)
dest_files <- basename(
  paste0(sapply( strsplit(source_files, "\\."), "[[", 1), ".", sapply( strsplit(source_files, "\\."), "[[", 3))
)
dest_files <- paste0(
  toupper(substring(dest_files, 1, 1)), 
  substring(dest_files, 2)
)

dest_rds <- file.path(
  params$extracted_dir, paste0("LEEF.bemovi.mag.16.bemovi.", timestamps), "5 - merged data", dest_files
)

dest_csv <- file.path(
  params$extracted_dir, paste0("LEEF.bemovi.mag.16.bemovi.", timestamps), gsub( "\\.rds$", ".csv", dest_files)
)
  
csv_files <- gsub("\\.rds$", ".csv", source_files)
```

## Update `.rds` files
```{r}
#| label = "update_bemovi_mag_16_rds"
pbmcapply::pbmclapply(
  sample(length(source_files)),
  function(i){
    file.copy(
      file.path(source_dir, source_files[i]),
      dest_rds[i],
      overwrite = TRUE
    )
  }, 
  mc.preschedule = FALSE,
  mc.cores = 2
)
```

## Update `.csv` files

```{r}
#| label = "update_bemovi_mag_16_csv"
pbmcapply::pbmclapply(
  sample(length(source_files)),
  function(i){
    write.csv(
      readRDS(file.path(source_dir, source_files[i])),
      dest_csv[i]
    )
  }, 
  mc.preschedule = FALSE,
  mc.cores = cores
)
```



# Update `bemovi.mag.25`

## Define paths and files
```{r}
#| label = "define_bemovi_mag_25_parameter"
source_dir <- file.path(input, "bemovi_mag_25")
source_files <- list.files(source_dir, pattern = ".rds$", recursive = TRUE)
timestamps <- sapply( strsplit(source_files, "\\."), "[[", 2)
dest_files <- basename(
  paste0(sapply( strsplit(source_files, "\\."), "[[", 1), ".", sapply( strsplit(source_files, "\\."), "[[", 3))
)
dest_files <- paste0(
  toupper(substring(dest_files, 1, 1)), 
  substring(dest_files, 2)
)

dest_rds <- file.path(
  params$extracted_dir, paste0("LEEF.bemovi.mag.25.bemovi.", timestamps), "5 - merged data", dest_files
)

dest_csv <- file.path(
  params$extracted_dir, paste0("LEEF.bemovi.mag.25.bemovi.", timestamps), gsub( "\\.rds$", ".csv", dest_files)
)
  
csv_files <- gsub("\\.rds$", ".csv", source_files)
```

## Update `.rds` files
```{r}
#| label = "update_bemovi_mag_25_rds"
pbmcapply::pbmclapply(
  sample(length(source_files)),
  function(i){
    file.copy(
      file.path(source_dir, source_files[i]),
      dest_rds[i],
      overwrite = TRUE
    )
  }, 
  mc.preschedule = FALSE,
  mc.cores = 2
)
```

## Update `.csv` files

```{r}
#| label = "update_bemovi_mag_25_csv"
pbmcapply::pbmclapply(
  sample(length(source_files)),
  function(i){
    write.csv(
      readRDS(file.path(source_dir, source_files[i])),
      dest_csv[i]
    )
  }, 
  mc.preschedule = FALSE,
  mc.cores = cores
)
```

# Update `flowcam`
## Define paths and files
```{r}
#| label = "define_flowcytometer_parameter"
source_dir <- file.path(input, "reclassification flowcam_b_02_20220128_30000000", "flowcam_b_02_20220128_30000000")
source_files <- list.files(source_dir, pattern = ".rds$", recursive = TRUE)
timestamps <- sapply( strsplit(source_files, "\\."), "[[", 2)
dest_files <- basename(
  paste0(sapply( strsplit(source_files, "\\."), "[[", 1), ".", sapply( strsplit(source_files, "\\."), "[[", 3))
)

dest_csv <- file.path(
  params$extracted_dir, paste0("LEEF.fast.flowcam.", timestamps), gsub( "\\.rds$", ".csv", dest_files)
)
  
csv_files <- gsub("\\.rds$", ".csv", source_files)
```

## Update `.csv` files

```{r}
#| label = "update_flowcytometer_csv"
pbmcapply::pbmclapply(
  sample(length(source_files)),
  function(i){
    write.csv(
      readRDS(file.path(source_dir, source_files[i])),
      dest_csv[i]
    )
  }, 
  mc.preschedule = FALSE,
  mc.cores = cores
)
```


# Re-create overlays


```{r overlays, eval = FALSE}


bemovi_dirs <- function(
){
  bemovis <- list.files(
    params$extracted_dir, 
    pattern = "^LEEF\\.bemovi\\.mag\\..*\\.bemovi\\..*$",
  )
  return(bemovis)
}

bemovi_ymls <- function(
    bemovi_dir
){
  ymls <- list.files(
    path = file.path(params$extracted_dir, bemovi_dir),
    pattern = "^bemovi_extract\\..*\\.*\\.yml$"
  )
  return(ymls)
}



pbmcapply::pbmclapply(
  bemovi_dirs(),
  function(bemovi_dir){
    bemovi_configs <- bemovi_ymls(bemovi_dir)
    lapply(
      bemovi_configs,
      function(bemovi_config, bemovi_dir){
        bc <- yaml::read_yaml(file.path(params$extracted_dir, bemovi_dir, bemovi_config))
        
        temp_overlay_folder <- file.path( params$extracted_dir, bemovi_dir, bc$temp.overlay.folder)
        overlay_folder <- file.path( params$extracted_dir, bemovi_dir, bc$overlay.folder)
        
        unlink(overlay_folder, recursive = TRUE, force = TRUE)
        dir.create(overlay_folder, recursive = TRUE)
        
        unlink(temp_overlay_folder, recursive = TRUE, force = TRUE)
        dir.create(temp_overlay_folder, recursive = TRUE)
    
        LEEF.analysis::overlays_from_folders(
          traj_data_file = file.path( params$extracted_dir, bemovi_dir, bc$merged.data.folder, bc$master ),
          avi_dir = file.path(params$avi_dir, bemovi_dir),
          bemovi_extract_yml_file = file.path(params$extracted_dir, bemovi_dir, bemovi_config),
          temp_overlay_folder = temp_overlay_folder,
          overlay_folder = overlay_folder,
          overlay_type = "both",
          label = "species",
          ffmpeg = "ffmpeg",
          font_size = 24,
          circle_size = 120,
          crf = 23,
          gamma = 2,
          mc_cores = cores
        )
      },
      bemovi_dir = bemovi_dir
    )
  }
)

```
