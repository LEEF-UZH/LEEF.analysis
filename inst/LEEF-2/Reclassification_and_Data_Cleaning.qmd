---
title: "Reclassification and Data Cleaning of LEEF-2 data"
author: "Rainer M Krug"

format:
  html:
    dev: png
    fig_width: 10
    fig_height: 12
    toc: true
    toc_float: true
    toc_collapsed: true
    code_folding: hide  
    embed-resources: true
params:
  release: "v2.3.2-LEEF-2"
  repo: "https://github.com/LEEF-UZH/LEEF.parameter/"
  output_dir: "/Volumes/RRD.Reclassification_final/RRD.Reclassification_final_LEEF-2/"
  db: "LEEF-2.RRD.sqlite"
  extracted_dir: "/Volumes/LEEF-2_archive/archive/extracted/"
  toc: "/Volumes/LEEF/0.TOC/LEEF-2/toc.rds"
  min_FSC.A: 2
  cores: 7
  remove_all:
    - airbubbles
    - OtherCiliate
    - Debris_and_other
    - Cryptomonas
  remove_flowcam:
    - Dexiostoma
    - Coleps_irchel
    - Colpidium
    - Loxocephallus
    - Tetrahymena
  keep_flowcytometer:
    - bacteria
    - algae
---

TODO: Chek for errors in pipeline and re-run these

# Setup
1. Download parameter as defined in the `params$version_tag` from the repo as defined in `parms$base` 
2. Create output directory as specified in `params$output_dir`
3. Check if `params$pre_processed_dir` and `params$extracted_dir` exist. The existance is only necessary for the re-classification and overlay creation (when done).
4. Create empty database `params$db` in directory `params$output_dir` database, unless it already exists


```{r}
#| label: setup
#| include: false 
#| 
if (!exists("params")){
   params <- rmarkdown::yaml_front_matter('~/git/0.RPackages/LEEF/analysis/LEEF.analysis/inst/LEEF-2/Reclassification_and_Data_Cleaning.qmd')$params
}

knitr::opts_chunk$set(
  echo = TRUE,
  eval = FALSE,
  message = TRUE,
  warning = TRUE
)

library("LEEF.analysis")
library(dplyr)
library(pbmcapply)
library(pbapply)
library(yaml)
library(tidyr)
library(DBI)
library(RSQLite)
library(lubridate)

db <- function(
    iteration = NULL,
    db_org = params$db,
    db_path = params$output_dir,
    version_tag = params$version_tag,
    temp = FALSE
){
  if (!is.null(iteration)){
    db_name <- gsub(
      pattern = ".sqlite", 
      replacement = paste0(".", version_tag, "_", iteration, ".sqlite"), 
      x = db_org
    )
  } else {
    db_name <- db_org
  }
  if (temp){
    db_name <- paste0(db_name, ".tmp")
  }
  return(file.path(db_path, db_name))
}

## 1. ------

pdir <- tempfile(pattern = paste0("parameter_", params$release))

dir.create(pdir, showWarnings = FALSE, recursive = TRUE)

on.exit({
  try(unlink(pdir), silent = TRUE)
})

download.file(
  url = paste0(params$repo, "archive/refs/tags/", params$release, ".zip"), 
  destfile = file.path(pdir, paste0(params$release, ".zip")),
  mode = "wb"
)

unzip(file.path(pdir, paste0(params$release, ".zip")), exdir = pdir)

parameter_dir <- list.dirs(pdir, recursive = FALSE)
  
## 2. -----
dir.create(params$output_dir, recursive = TRUE, showWarnings = FALSE)

## 3. -----

if (!file.exists(params$extracted_dir)){
  warning(
    "This is not a problem when not reclassifying! \n",
    "Archive directory is not valid! \n",
    "It does not contain the folder '", params$extracted_dir, "'.\n",
    "Probably not mounted?" 
  )
}

## 4. -----

if (file.exists(db())) {
  stop(db(), " exists and will not be overwritten!\n", "If you want to re-generate, please rename the database or delete it!")
} else {
  RRD_new(db(), LEEF = "LEEF-2")
  ## Adding of General Parameter tables
  
  suppressMessages(  
    add_to_db(
      fns = file.path(parameter_dir, "parameter", "00.general.parameter", "compositions.csv"),
      db = db(),
      tables = "composition",
      remove_timestamps = NULL,
      check_timestamps = FALSE,
      backup_removed = TRUE
    )
  )
  
  suppressMessages(  
    add_to_db(
      fns = file.path(parameter_dir, "parameter", "00.general.parameter", "experimental_design.csv"),
      db = db(),
      tables = "experimental_design",
      remove_timestamps = NULL,
      check_timestamps = FALSE,
      backup_removed = TRUE
    )
  )
  
  suppressMessages(  
    add_to_db(
      fns = file.path(parameter_dir, "treatment", "stressor_levels.csv"),
      db = db(),
      tables = "stressor_levels",
      remove_timestamps = NULL,
      check_timestamps = FALSE,
      backup_removed = TRUE
    )
  )
  
}
```

# 1. Re-calculations for all timestamps
## Reclassification of Flowcam

### Timestamps Flowcam
```{r}
#| label: flowcam_timestamps
#| 

timestamps <- list.files(
  path = params$extracted_dir, 
  pattern = "^LEEF\\.flowcam\\.flowcam\\.",
  recursive = FALSE, 
  full.names = FALSE
)
timestamps <- gsub("^LEEF\\.flowcam\\.flowcam\\.", "", timestamps)
```

### Classify Flowcam
```{r}
#| label: flowcam_classify
#| 

out <- file.path(params$output_dir, "flowcam")

if (!file.exists(out)) {
  message("Classifying flowcam...")
  system.time(
    LEEF_2_classify_flowcam_archive(
      extracted_dir = params$extracted_dir, 
      timestamps = timestamps, 
      algae_traits_name = "algae_traits_filtered.rds", 
      classifier = readRDS(file.path(parameter_dir, "parameter", "0.raw.data", "flowcam", "svm_flowcam_classifiers.rds")), 
      species_tracked = yaml::read_yaml(file.path(parameter_dir, "parameter", "0.raw.data", "flowcam", "flowcam.yml"))$species_tracked,
      output = out,
      mc.cores = params$cores
    )
  )
} else {
  message(
    "Directory ", out, "exists\n",
    "skipping Flowcam classification."
  )
}
```


### Clean Up Flowcam
```{r}
#| label: flowcam_cleanup
#| 

rm(timestamps)
```


### TODO Calculate Biomass Flowcam
The biomass is calculated here

```{r}
#| label: flowcam_biomass
#| eval: false

fns <- list.files(
  path = file.path(params$output_dir, "flowcam"), 
  pattern = "algae_traits",
  recursive = FALSE,
  full.names = TRUE
)

pbmcapply::pbmclapply(
  fns,
  function(fn_traits){
    fn_dens <- fn_traits |> 
      gsub(
        pattern = "algae_traits", 
        replacement = "algae_density"
      )
    biomass_flowcam <- LEEF_2_biomass_flowcam(
      algae_traits = readRDS(fn_traits),
      algae_density = readRDS(fn_dens)
    )
    
    saveRDS(biomass_flowcam$traits, file = fn_traits)
    saveRDS(biomass_flowcam$density, file = fn_dens)
  }, 
  mc.preschedule = FALSE,
  mc.cores = params$cores
)
```


## Reclassification of Bemovi 16
### Timestamps Bemovi 16
```{r}
#| label: bemovi_16_timestamps
#| 

timestamps <- list.files(
  path = params$extracted_dir, 
  pattern = "^LEEF\\.bemovi\\.mag\\.16\\.bemovi\\.",
  recursive = FALSE, 
  full.names = FALSE
)
timestamps <- gsub("^LEEF\\.bemovi\\.mag\\.16\\.bemovi\\.", "", timestamps)
```

### Classify `bemovi_extract.mag.16.yml`
```{r}
#| label: bemovi_16_classify
#| 

moving_background <- NULL

out <- file.path(params$output_dir, "bemovi_mag_16")

if (!file.exists(out)) {
  message("Classifying bemovi_extract.mag.16")
  LEEF_2_classify_bemovi_archive( 
    timestamps = timestamps, 
    extracted_dir = params$extracted_dir, 
    magnification = 16, 
    classifier = readRDS(file.path(parameter_dir, "parameter", "0.raw.data", "bemovi.mag.16", "svm_video_classifiers_16x.rds")), 
    bemovi_extract_name = file.path(parameter_dir, "parameter", "0.raw.data", "bemovi.mag.16", "bemovi_extract.mag.16.yml"), 
    output = out,
    exclude_videos = moving_background,
    mc.cores = params$cores
  )
} else {
  message(
    "Directory ", out, " exists\n",
    "Skipping bemovi_extract.mag.16 classification."
  )
}
```

### Clean Up Bemovi 16
```{r}
#| label: bemovi_16_cleanup
#| 

rm(timestamps)
```

### TODO Calculate Biomass Bemovi 16
The biomass is calculated here

```{r}
#| label: bemovi_16_biomass
#| eval: false
#| 

fns <- list.files(
  path = file.path(params$output_dir, "bemovi_mag_16"), 
  pattern = "morph_mvt",
  recursive = FALSE,
  full.names = TRUE
)

# pbmcapply::pbmclapply(
lapply(
  fns,
  function(fn_traits){
    fn_dens <- fn_traits |>
        gsub(
            pattern = "morph_mvt",
            replacement = "mean_density_per_ml"
        )
    timestamp <- substr(
        fn_traits,
        start = nchar(fn_traits) - 11,
        stop = nchar(fn_traits) - 4
    ) |>
        as.numeric()

    traits <- readRDS(fn_traits) |>
      mutate(timestamp = timestamp)

    dens$timestamp <- timestamp 

    biomass_bemovi_16 <- LEEF_2_biomass_bemovi_16(
      ciliate_traits_16 = traits,
      ciliate_density_16 = readRDS(fn_dens)
    )
    # select the last 12 characters of a string
    


    saveRDS(biomass_bemovi_16$traits, file = fn_traits)
    saveRDS(biomass_bemovi_16$density, file = fn_dens)
  }# , 
  # mc.preschedule = FALSE,
  # mc.cores = params$cores
)

```


## Reclassification of Bemovi 25
### Timestamps Bemovi 25
```{r}
#| label: bemovi_25_timestamps

timestamps <- list.files(
  path = params$extracted_dir, 
  pattern = "^LEEF\\.bemovi\\.mag\\.25\\.bemovi\\.",
  recursive = FALSE, 
  full.names = FALSE
)
timestamps <- gsub("^LEEF\\.bemovi\\.mag\\.25\\.bemovi\\.", "", timestamps)
```

### TODO Classify `bemovi_mag.25` excluding moving_background

```{r}
#| label: bemovi_25_classify
#| 

moving_background <- NULL

out <- file.path(params$output_dir, "bemovi_mag_25")
if (!file.exists(out)) {
  system.time(
    suppressMessages(
      LEEF_2_classify_bemovi_archive( 
        timestamps = timestamps, 
        magnification = 25, 
        classifier = readRDS(file.path(parameter_dir, "parameter", "0.raw.data", "bemovi.mag.16", "svm_video_classifiers_25x.rds")), 
        bemovi_extract_name = file.path(parameter_dir, "parameter", "0.raw.data", "bemovi.mag.16", "bemovi_extract.mag.25.yml"),
        output = out,
        exclude_videos = moving_background,
        mc.cores = params$cores
      )
    )
  )
  system.time(
    suppressMessages(
      LEEF_2_classify_bemovi_archive( 
        timestamps = timestamps, 
        magnification = 25, 
        classifier_name = "svm_video_classifiers_25x.rds", 
        bemovi_extract_name = "bemovi_extract.mag.25.non_cropped.yml", 
        species_tracked = yaml::read_yaml(paste0(base, "parameter/bemovi.mag.25/bemovi_extract.mag.25.non_cropped.yml"))$species_tracked,
        output = out,
        exclude_videos = moving_background,
        mc.cores = params$cores
      )
    )
  )
  system.time(
    suppressMessages(
      LEEF_2_classify_bemovi_archive( 
        timestamps = timestamps, 
        archive_dir = params$archive_dir, 
        magnification = 25, 
        classifier_name = "svm_video_classifiers_25x.rds", 
        bemovi_extract_name = "bemovi_extract.mag.25.cropped.yml", 
        species_tracked = yaml::read_yaml(paste0(base, "parameter/bemovi.mag.25/bemovi_extract.mag.25.cropped.yml"))$species_tracked,
        output = out,
        exclude_videos = moving_background,
        mc.cores = params$cores
      )
    )
  )
} else {
  message(
    "Directory ", out, "exists\n",
    "Skipping all bemovi_mag_25 classifcations"
  )
}
```

### Clean Up Bemovi 25
```{r}
#| label: bemovi_25_cleanup
#| 

rm(timestamps)
```


### TODO Calculate Biomass Bemovi 25
The biomass is calculated here

```{r}
#| label: bemovi_25_biomass
#| eval: false

## Bemovi 25

fns <- list.files(
  path = file.path(params$output_dir, "bemovi_mag_25"), 
  pattern = "morph_mvt\\.",
  recursive = FALSE,
  full.names = TRUE
)

pbmcapply::pbmclapply(
  fns,
  function(fn_traits){
    fn_dens <- fn_traits |> 
      gsub(
        pattern = "morph_mvt", 
        replacement = "mean_density_per_ml"
      )
    biomass_bemovi_25 <- LEEF_2_biomass_bemovi_25(
      ciliate_traits_25 = readRDS(fn_traits),
      ciliate_density_25 = readRDS(fn_dens)
    )
    
    saveRDS(biomass_bemovi_25$traits, file = fn_traits)
    saveRDS(biomass_bemovi_25$density, file = fn_dens)
  }, 
  mc.preschedule = FALSE,
  mc.cores = params$cores
)

## Bemovi 25 cropped

fns <- list.files(
  path = file.path(params$output_dir, "bemovi_mag_25"), 
  pattern = "morph_mvt_cropped\\.",
  recursive = FALSE,
  full.names = TRUE
)

pbmcapply::pbmclapply(
  fns,
  function(fn_traits){
    fn_dens <- fn_traits |> 
      gsub(
        pattern = "morph_mvt", 
        replacement = "mean_density_per_ml"
      )
    biomass_bemovi_25 <- LEEF_2_biomass_bemovi_25_cropped(
      ciliate_traits_25 = readRDS(fn_traits),
      ciliate_density_25 = readRDS(fn_dens)
    )
    
    saveRDS(biomass_bemovi_25$traits, file = fn_traits)
    saveRDS(biomass_bemovi_25$density, file = fn_dens)
  }, 
  mc.preschedule = FALSE,
  mc.cores = params$cores
)

## Bemovi 25 non_cropped

fns <- list.files(
  path = file.path(params$output_dir, "bemovi_mag_25"), 
  pattern = "morph_mvt_non_cropped\\.",
  recursive = FALSE,
  full.names = TRUE
)

pbmcapply::pbmclapply(
  fns,
  function(fn_traits){
    fn_dens <- fn_traits |> 
      gsub(
        pattern = "morph_mvt", 
        replacement = "mean_density_per_ml"
      )
    biomass_bemovi_25 <- LEEF_2_biomass_bemovi_25_non_cropped(
      ciliate_traits_25 = readRDS(fn_traits),
      ciliate_density_25 = readRDS(fn_dens)
    )
    
    saveRDS(biomass_bemovi_25$traits, file = fn_traits)
    saveRDS(biomass_bemovi_25$density, file = fn_dens)
  }, 
  mc.preschedule = FALSE,
  mc.cores = params$cores
)
```






## TODO Add to database and create indices
Old timestamps will be removed and not be backed up.

```{r}
#| label: addRRD_copy_temp
#| 

file.copy(db(), db(1, temp = TRUE))
```
```{r}
#| label: addRRD_b16
#| 

## Bemovi_16

suppressMessages(
  add_reclassified_to_db(
    path = params$output_dir, 
    db = db_name(1, temp = TRUE), 
    remove_timestamps = NULL,
    backup_removed = FALSE,
    methods = "bemovi_mag_16"
  )
)
```
```{r}
#| label: addRRD_b25
#| 

## Bemovi_25

suppressMessages(
  add_reclassified_to_db(
    path = params$output_dir, 
    db = db_name(1, temp = TRUE), 
    remove_timestamps = NULL,
    backup_removed = FALSE,
    methods = "bemovi_mag_25"
  )
)
```
```{r}
#| label: addRRD_flowcam
#| 

## flowcam

suppressMessages(
  add_reclassified_to_db(
    path = params$output_dir, 
    db = db_name(1, temp = TRUE), 
    remove_timestamps = NULL,
    backup_removed = FALSE,
    methods = "flowcam"
  )
)
```

```{r}
#| label: addRRD_flowcytometer_density
#| eval: false
#| 

## Flowcytometer Densities

f_dirs <- list.dirs(
    params$extracted_dir,
    recursive = FALSE,
    full.names = TRUE
) |>
    grep(pattern = "LEEF\\.flowcytometer\\.flowcytometer\\.", value = TRUE)

fns_dens <- file.path(f_dirs, "flowcytometer_density.csv")


suppressMessages(
  add_to_db(
    fns_dens,
    db = db_name(1, temp = TRUE),
    tables = rep("flowcytometer__flowcytometer_density", length(fns_dens)),
    remove_timestamps = NULL,
    check_timestamps = FALSE,
    backup_removed = TRUE
  )
)

rm(f_dirs, fns_dens)
```
```{r}
#| label:  addRRD_flowcytometer_traits
#| eval: false
#| 

## Flowcytometer Traits

f_dirs <- list.dirs(
    params$extracted_dir,
    recursive = FALSE,
    full.names = TRUE
) |>
    grep(pattern = "LEEF\\.flowcytometer\\.flowcytometer\\.", value = TRUE)

fn_traits <- c(
    file.path(f_dirs, "flowcytometer_traits_algae.rds"),
    file.path(f_dirs, "flowcytometer_traits_bacteria.rds")
)

suppressMessages(
  add_to_db(
    fns_traits,
    db = db_name(1, temp = TRUE),
    tables = rep("flowcytometer__flowcytometer_traits", length(fns_traits)),
    remove_timestamps = NULL,
    check_timestamps = FALSE,
    backup_removed = TRUE
  )
)

rm(f_dirs, fn_traits)
```
```{r}
#| label: addRRD_add_indices
#| 

RRD_create_indices(
  db_name(1, temp = TRUE), 
  LEEF = "LEEF-1", 
  continue_after_error = TRUE
)

```
```{r}
#| label: addRRD_finalize
#| 

file.rename(db_name(1, temp = TRUE), db_name(1, temp = FALSE))
```




# TODO 3. Add O2, Manualcount and TOC measuremnts 

## Prepare
```{r}
#| label: prepare_tab
file.copy(db_name(2, temp = FALSE), db_name(3, temp = TRUE))
```

## Add detrended TOC - Removing the linear trend in the water chemistry 
[ ] Translate and wording
In the OC meter ( Type ), "der Katalysator in der Säule vom Brenner vom TOCA wurde am 27.2.23 und am 23.05.23 gewechselt." All measurements after DATE were done using the new THING.
Bis samples L2_20230220A mit dem Katalysator der Yves schon nutzte. Samples L2_20230224A-L2_20230505A mit dem Katalysator vom 27.2.23. Samples L2_20230508A-.... mit dem Katalysator vom 23.5.23

```{r}
#| label: add_toc
#| 

toc <- readRDS(params$toc) %>%
  left_join(
    db_read_table(db = db_name(3, temp = TRUE), table = "experimental_design") %>% 
      collect(),
    by = join_by(bottle)
    ) %>%
  filter(!is.na(conc))

colnames_toc <- colnames(toc)

toc$day <- as.Date(as.character(toc$timestamp), "%Y%m%d") - min(as.Date(as.character(toc$timestamp), "%Y%m%d") )
toc$day <- as.numeric(toc$day)

toc$analysis_time2 <- lubridate::as_datetime(toc$anaysis_time, format="%Y-%m-%d %H:%M") # wrong time zones, but doesn't matter 
toc$analysis_time2 <- sapply(toc$analysis_time2, function(d){
  paste0(unlist(strsplit(as.character(d), "-")), collapse = "")
})

toc <- toc %>%
  dplyr::mutate(
    light_phase = case_when(
      temperature == "constant" ~ "constant",
      day < 93 ~ "constant before decrease",
      day >= 93 & day < 198 ~ "decreasing",
      day >= 198 ~ "constant after decrease"),
    int = interaction(analysis_time2, light_phase)
  )  %>%
  arrange(timestamp)

toc_list <- split(
  toc, 
  f = toc$int, 
  drop = T
)

toc_list <- pbmcapply::pbmclapply(
  toc_list, 
  function(df){
    if(nrow(df) < 3*4) { # at least 3 bottles per type to do the detrending
      df$concentration.detrended <- df$conc
      return(df)
    }
    
    df <- lapply(
      c("IC", "TC", "TN", "TOC"), 
      function(Type){
        df2 <- df %>% filter(inj_type==Type)
        m <- lm(conc ~ position, data = df2)
        predict <- predict(m) - predict(m)[1]
        df2$concentration.detrended <- df2$conc - predict
        df2
      }
    )
    do.call("rbind",df)
  }, 
  mc.cores = 7
)

toc <- do.call("rbind",toc_list)
toc$conc_org <- toc$conc
toc$conc  <- toc$concentration.detrended


toc <- toc |>
  select(
    -c(
      "temperature", 
      "richness", 
      "composition", 
      "incubator", 
      "day", 
      "analysis_time2", 
      "light_phase", 
      "int", 
      "concentration.detrended"
    )
  )
toc_det <- tempfile(fileext = ".rds")
saveRDS(toc, toc_det)

add_to_db(
  toc_det,
  db = db_name(3, temp = TRUE),
  tables = "toc__toc",
  remove_timestamps = NULL,
  check_timestamps = TRUE,
  backup_removed = TRUE
)

unlink(toc_det)
```

## Add O2
```{r}
#| label: add_o2
#| 

fns_o2 <- list.files(
  path = params$extracted_dir, 
  pattern = "^LEEF\\.fast\\.o2meter\\.",
  recursive = FALSE, 
  full.names = TRUE
) |>
  file.path("o2meter.csv")

suppressMessages(
  add_to_db(
    fns_o2,
    db = db_name(3, temp = TRUE),
    tables = rep("o2meter__o2meter", length(fns_o2)),
    remove_timestamps = NULL,
    check_timestamps = TRUE,
    backup_removed = TRUE
  )
)
```


## Add manualcount
```{r}
#| label: add_manualcount
#| 

fns_mc <- list.files(
  path = params$extracted_dir, 
  pattern = "^LEEF\\.fast\\.manualcount\\.",
  recursive = FALSE, 
  full.names = TRUE
) |>
  file.path("manualcount_density.csv")

suppressMessages(
  add_to_db(
    fns_mc,
    db = db_name(3, temp = TRUE),
    tables = rep("manualcount__manualcount_density", length(fns_mc)),
    remove_timestamps = NULL,
    check_timestamps = TRUE,
    backup_removed = TRUE
  )
)
```


## Finalize
```{r}
#| label: finalize_tab
#| 
file.rename(db_name(3, temp = TRUE), db_name(3, temp = FALSE))
```

# TODO Create Diagnostic Report
The Diagnostic report needs to be created before the renaming as it does rely on the otriginal terminology.

```{r}
#| label: createDiagReport
#| 

report_diagnostic(
  db = db_name(3, temp = FALSE),  
  template = "LEEF_1",
  suffix = paste0("reclassified_", params$version_tag), 
  format = "html"
)
```


# TODO 4. Rename species and columns
```{r}
#| label: rename

file.copy(db_name(3, temp = FALSE), db_name(4, temp = TRUE))

RRD_LEEF_1_rename(db = db_name(4, temp = TRUE))

file.rename(db_name(4, temp = TRUE), db_name(4, temp = FALSE))
```

```{r}
#| label: create final db

file.copy(db_name(4, temp = FALSE), db_name("final", temp = FALSE))
```

# TODO Do a final vacuuming into new database
Vacuuming the database will take some time!

To vacuum the sqlite database, i.e. recover the space from the deletion of rows, please run the following command in the directory where the database is located. I do not expect this to have a big impact on the size.

```{r echo = FALSE}
cat(
  paste0(
    "sqlite3 \"./", basename(db_name("final", temp = FALSE)), "\" 'VACUUM main INTO \"", db_name("final_vacuumed", temp = FALSE), "\"'"
    )
)
```

# TODO Create Overlays
TODO This is still using the extracted and pre-processed folder and needs to be changed to use the reclassified bemovi data. 
```{r}
#| label: overlays
#| eval: false

generate_overlays(
  params = params,
  overwrite = FALSE
)
```



